#!/usr/bin/env python3
"""
ìƒ˜í”Œ ì¼€ì´ìŠ¤ ìƒì„±ê¸° - í—¤ë” ë³€í˜•ìœ¼ë¡œ í•™ìŠµ ë°ì´í„° ì¦ê°•
"""
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from internal.memory.case_store import CaseStore

# ë‹¤ì–‘í•œ í—¤ë” íŒ¨í„´ë“¤ (ì‹¤ì œ ê³ ê° íŒŒì¼ì—ì„œ ìì£¼ ë³´ì´ëŠ” ë³€í˜•ë“¤)
SAMPLE_PATTERNS = [
    {
        "name": "í‘œì¤€í˜•",
        "headers": ["ì‚¬ì›ë²ˆí˜¸", "ìƒë…„ì›”ì¼", "ì„±ë³„", "ì…ì‚¬ì¼ì", "ì¢…ì—…ì›êµ¬ë¶„", "ê¸°ì¤€ê¸‰ì—¬", "í‡´ì§ê¸ˆì¶”ê³„ì•¡"],
    },
    {
        "name": "ì•½ì–´í˜•",
        "headers": ["ì‚¬ë²ˆ", "ìƒì¼", "ì„±ë³„ì½”ë“œ", "ì…ì‚¬", "ì§ì›êµ¬ë¶„", "ê¸‰ì—¬", "í‡´ì§ê¸ˆ"],
    },
    {
        "name": "ì˜ë¬¸í˜•",
        "headers": ["emp_no", "birth_date", "gender", "hire_date", "emp_type", "salary", "severance"],
    },
    {
        "name": "í˜¼í•©í˜•",
        "headers": ["ì§ì›ë²ˆí˜¸", "DOB", "M/F", "ì…ì‚¬ì¼", "êµ¬ë¶„", "ì›”ê¸‰ì—¬", "ì˜ˆìƒí‡´ì§ê¸ˆ"],
    },
    {
        "name": "ê³µë°±í¬í•¨í˜•",
        "headers": ["ì‚¬ì› ë²ˆí˜¸", "ìƒë…„ ì›”ì¼", "ì„± ë³„", "ì…ì‚¬ ì¼ì", "ì¢…ì—…ì› êµ¬ë¶„", "ê¸°ì¤€ ê¸‰ì—¬"],
    },
    {
        "name": "ê´„í˜¸ì„¤ëª…í˜•",
        "headers": [
            "ì‚¬ì›ë²ˆí˜¸(í•„ìˆ˜)",
            "ìƒë…„ì›”ì¼(YYYYMMDD)",
            "ì„±ë³„(1:ë‚¨,2:ì—¬)",
            "ì…ì‚¬ì¼ì(í•„ìˆ˜)",
            "ì¢…ì—…ì›êµ¬ë¶„(1:ì§ì›,3:ì„ì›)",
            "ê¸°ì¤€ê¸‰ì—¬(ì›)",
        ],
    },
    {
        "name": "í™•ì¥í˜•",
        "headers": [
            "ì‚¬ì›ë²ˆí˜¸", "ìƒë…„ì›”ì¼", "ì„±ë³„", "ì…ì‚¬ì¼ì", 
            "ë¶€ì„œ", "ì§ê¸‰", "ì¢…ì—…ì›êµ¬ë¶„", "ê¸°ì¤€ê¸‰ì—¬",
            "ë‹¹ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡", "ì°¨ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡", "ì ìš©ë°°ìˆ˜", "ì œë„êµ¬ë¶„"
        ],
    },
    {
        "name": "ìµœì†Œí˜•",
        "headers": ["ì‚¬ë²ˆ", "ìƒë…„ì›”ì¼", "ì…ì‚¬ì¼", "ê¸‰ì—¬"],
    },
]

# í‘œì¤€ í•„ë“œ ë§¤í•‘ (ìˆ˜ë™ìœ¼ë¡œ ì •ì˜ - í•™ìŠµìš©)
MANUAL_MAPPINGS = {
    "ì‚¬ì›ë²ˆí˜¸": "ì‚¬ì›ë²ˆí˜¸", "ì‚¬ë²ˆ": "ì‚¬ì›ë²ˆí˜¸", "emp_no": "ì‚¬ì›ë²ˆí˜¸", "ì§ì›ë²ˆí˜¸": "ì‚¬ì›ë²ˆí˜¸",
    "ì‚¬ì› ë²ˆí˜¸": "ì‚¬ì›ë²ˆí˜¸", "ì‚¬ì›ë²ˆí˜¸(í•„ìˆ˜)": "ì‚¬ì›ë²ˆí˜¸",
    
    "ìƒë…„ì›”ì¼": "ìƒë…„ì›”ì¼", "ìƒì¼": "ìƒë…„ì›”ì¼", "birth_date": "ìƒë…„ì›”ì¼", "DOB": "ìƒë…„ì›”ì¼",
    "ìƒë…„ ì›”ì¼": "ìƒë…„ì›”ì¼", "ìƒë…„ì›”ì¼(YYYYMMDD)": "ìƒë…„ì›”ì¼",
    
    "ì„±ë³„": "ì„±ë³„", "ì„±ë³„ì½”ë“œ": "ì„±ë³„", "gender": "ì„±ë³„", "M/F": "ì„±ë³„",
    "ì„± ë³„": "ì„±ë³„", "ì„±ë³„(1:ë‚¨,2:ì—¬)": "ì„±ë³„",
    
    "ì…ì‚¬ì¼ì": "ì…ì‚¬ì¼ì", "ì…ì‚¬": "ì…ì‚¬ì¼ì", "hire_date": "ì…ì‚¬ì¼ì", "ì…ì‚¬ì¼": "ì…ì‚¬ì¼ì",
    "ì…ì‚¬ ì¼ì": "ì…ì‚¬ì¼ì", "ì…ì‚¬ì¼ì(í•„ìˆ˜)": "ì…ì‚¬ì¼ì",
    
    "ì¢…ì—…ì›êµ¬ë¶„": "ì¢…ì—…ì›êµ¬ë¶„", "ì§ì›êµ¬ë¶„": "ì¢…ì—…ì›êµ¬ë¶„", "emp_type": "ì¢…ì—…ì›êµ¬ë¶„", "êµ¬ë¶„": "ì¢…ì—…ì›êµ¬ë¶„",
    "ì¢…ì—…ì› êµ¬ë¶„": "ì¢…ì—…ì›êµ¬ë¶„", "ì¢…ì—…ì›êµ¬ë¶„(1:ì§ì›,3:ì„ì›)": "ì¢…ì—…ì›êµ¬ë¶„",
    
    "ê¸°ì¤€ê¸‰ì—¬": "ê¸°ì¤€ê¸‰ì—¬", "ê¸‰ì—¬": "ê¸°ì¤€ê¸‰ì—¬", "salary": "ê¸°ì¤€ê¸‰ì—¬", "ì›”ê¸‰ì—¬": "ê¸°ì¤€ê¸‰ì—¬",
    "ê¸°ì¤€ ê¸‰ì—¬": "ê¸°ì¤€ê¸‰ì—¬", "ê¸°ì¤€ê¸‰ì—¬(ì›)": "ê¸°ì¤€ê¸‰ì—¬",
    
    "í‡´ì§ê¸ˆì¶”ê³„ì•¡": "ë‹¹ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡", "í‡´ì§ê¸ˆ": "ë‹¹ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡", "severance": "ë‹¹ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡",
    "ì˜ˆìƒí‡´ì§ê¸ˆ": "ë‹¹ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡", "ë‹¹ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡": "ë‹¹ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡",
    
    "ì°¨ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡": "ì°¨ë…„ë„í‡´ì§ê¸ˆì¶”ê³„ì•¡",
    "ì ìš©ë°°ìˆ˜": "ì ìš©ë°°ìˆ˜",
    "ì œë„êµ¬ë¶„": "ì œë„êµ¬ë¶„",
    "ë¶€ì„œ": "ë¶€ì„œ",
    "ì§ê¸‰": "ì§ê¸‰",
}


def generate_matches(headers: list) -> list:
    """í—¤ë”ì— ëŒ€í•œ ë§¤ì¹­ ê²°ê³¼ ìƒì„±"""
    matches = []
    for h in headers:
        target = MANUAL_MAPPINGS.get(h)
        if target:
            matches.append({
                "source": h,
                "target": target,
                "confidence": 0.95,  # ìˆ˜ë™ ë§¤í•‘ì´ë¯€ë¡œ ë†’ì€ ì‹ ë¢°ë„
                "fallback": False,
            })
        else:
            matches.append({
                "source": h,
                "target": None,
                "confidence": 0.0,
                "unmapped": True,
            })
    return matches


def main():
    print("=" * 60)
    print("ğŸ§ª ìƒ˜í”Œ ì¼€ì´ìŠ¤ ìƒì„±ê¸°")
    print("=" * 60)
    
    store = CaseStore()
    created = 0
    
    for pattern in SAMPLE_PATTERNS:
        name = pattern["name"]
        headers = pattern["headers"]
        matches = generate_matches(headers)
        
        # ë§¤í•‘ëœ ê²ƒë§Œ ì¹´ìš´íŠ¸
        mapped = sum(1 for m in matches if m.get("target"))
        confidence = mapped / len(headers) if headers else 0
        
        case_id = store.save_case(
            headers=headers,
            matches=matches,
            confidence=confidence,
            was_auto_approved=True,
            human_corrections=None,
            metadata={
                "source": "synthetic",
                "pattern_name": name,
                "generated": True,
            }
        )
        
        print(f"âœ… {name}: {len(headers)}ê°œ í—¤ë”, {mapped}ê°œ ë§¤í•‘, ID={case_id}")
        created += 1
    
    print()
    print("=" * 60)
    print(f"ğŸ“Š ìƒì„± ì™„ë£Œ: {created}ê°œ ìƒ˜í”Œ ì¼€ì´ìŠ¤")
    print("=" * 60)
    
    # ìµœì¢… í†µê³„
    stats = store.get_stats()
    print(f"\nğŸ“ˆ ì „ì²´ í†µê³„:")
    print(f"  ì´ ì¼€ì´ìŠ¤: {stats['total_cases']}ê°œ")
    print(f"  ìë™ ìŠ¹ì¸: {stats['auto_approved']}ê°œ")
    print(f"  í—¤ë” íŒ¨í„´: {stats.get('unique_headers', 'N/A')}ê°œ")


if __name__ == "__main__":
    main()
