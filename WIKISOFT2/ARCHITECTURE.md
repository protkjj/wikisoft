# 🏗️ WIKISOFT2 아키텍처 개요

**버전**: 2.1  
**최종 업데이트**: 2025-12-26

---

## 🎯 목표

HR 명부를 자동으로 검증하고, 고객사별 비표준 헤더를 자연스럽게 매칭하며, 결과를 Excel 경고로 직관적으로 전달하는 시스템.

---

## 🧩 전체 구성

```
┌────────────────────────────────────────┐
│  1️⃣ 파일 업로드 (Excel)                │
│  - 재직/퇴직/추가 시트                 │
└──────────────┬─────────────────────────┘
               ↓
┌────────────────────────────────────────┐
│  2️⃣ 헤더 매칭                          │
│  - 기본: 문자열 유사도(SequenceMatcher) │
│  - 선택: AI(GPT-4o)                     │
└──────────────┬─────────────────────────┘
               ↓
┌────────────────────────────────────────┐
│  3️⃣ 자동 집계 계산                     │
│  - 인원·금액 집계                       │
│  - 퇴직자 총합 자동 계산(q24+q25+q26)   │
└──────────────┬─────────────────────────┘
               ↓
┌────────────────────────────────────────┐
│  4️⃣ 교차 검증 (Layer 2)                │
│  - 챗봇 답변 ↔ 명부 계산값 비교         │
│  - 경고/정보 메시지                     │
└──────────────┬─────────────────────────┘
               ↓
┌────────────────────────────────────────┐
│  5️⃣ Excel 출력                         │
│  - 셀 강조(빨강/노랑)                   │
└────────────────────────────────────────┘
```

---

## 🧱 주요 컴포넌트

- API 서버: `external/api/main.py` (FastAPI)
- 파서: `internal/parsers/ceragem_parser.py`
- 헤더 매칭: `internal/ai/column_matcher.py`
- 집계 계산: `internal/generators/aggregate_calculator.py`
- Excel 출력: `internal/generators/sheet_generator.py`
- 검증: `internal/processors/validation_layer1.py`, `internal/processors/validation_layer2.py`
- 질문: `internal/ai/diagnostic_questions.py` (총 24개)
- 설정: `internal/config/schema_config.py`, `internal/config/prompt_config.py`
- 에이전트 프레임워크: `internal/tools/*`, `internal/agent/*`

---

## ⚙️ 운영 모드

- 폴백(기본): 문자열 유사도 기반, 정확도 약 70%±, 오프라인/내부망에서도 동작
- AI(선택): `.env`의 `OPENAI_API_KEY` 설정 시 GPT-4o로 매칭, 정확도 95%+

---

## 🔎 헤더 매칭 설계

- 헤더 정규화(`normalize_header`):
  - 개행 제거, 괄호 내용 제거, 다중 공백 축약, 소문자화
- 유사도 비교:
  - 표준 필드명 및 별칭(`aliases`)과 `SequenceMatcher`로 유사도 점수 산출
- 매칭 결과:
  - 임계값 미만은 `unmapped`로 분류, 필수 필드 누락·낮은 신뢰도·매칭 실패 비율 과다 시 경고
- AI 모드:
  - GPT-4o 프롬프트로 고객 헤더 → 표준 필드 매핑(근거 `reason` 포함)

---

## 🗂️ 진단 질문 (총 24개)

- 기본 데이터 품질(14): WIKISOFT1과 동일한 기초 품질 확인
- 인원 집계(6): 재직/퇴직 유형별(임원/직원/계약직) 수량 입력
- 금액 집계(4): 퇴직급여 관련 금액 항목 집계·전환·기타 반환
- 자동 계산: 퇴직자 총합은 q24+q25+q26으로 계산하여 질문 제거

---

## 🔌 API 엔드포인트

- `GET /diagnostic-questions`: 24개 질문 조회
- `POST /validate-with-roster`: Layer 2 교차 검증 실행
- `POST /generate-with-validation`: Excel 다운로드

---

## 🚀 배포·운영 노트

- 포트: API `8000`
- 환경: `.env`에 `OPENAI_API_KEY`(선택), 세션 파라미터 등
- 파일 크기 제약: 50MB, 50k 행 기준 권장
- 로깅: 구조화 로깅(정보/경고 중심)

---

## 📌 합의된 방향성 요약

- "자연스러운 매칭"을 기본으로, AI는 선택적 가속기로 사용
- UX는 질문 최소화·뒤로가기·버튼 위치 고정 등 실무 친화성 우선
- 경고는 투명성 확보 목적(차단보다는 안내 중심)
